<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é”®ç›˜å‹å¥½å‹è¡¨æ ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
        }

        .controls {
            margin-bottom: 15px;
        }

        .btn {
            padding: 8px 16px;
            margin-right: 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .table-wrapper {
            overflow-x: auto;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #ddd;
        }

        th {
            background: #f8f9fa;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #ddd;
            color: #333;
        }

        td {
            padding: 0;
            border: 1px solid #ddd;
            position: relative;
        }

        td input,
        td select {
            width: 100%;
            padding: 10px;
            border: 2px solid transparent;
            outline: none;
            font-size: 14px;
            background: transparent;
            transition: all 0.2s;
        }

        td input:focus,
        td select:focus {
            border-color: #007bff;
            background: #f0f8ff;
        }

        td input[type="number"] {
            text-align: right;
        }

        tfoot {
            background: #e9ecef;
            font-weight: 600;
        }

        tfoot td {
            padding: 12px;
            color: #495057;
        }

        .sum-cell {
            text-align: right;
            font-size: 15px;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 12px;
            transition: background 0.3s;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .output h3 {
            margin-bottom: 10px;
            color: #333;
        }

        .output pre {
            background: white;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
            line-height: 1.5;
        }

        .tip {
            background: #fff3cd;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            border-left: 4px solid #ffc107;
            font-size: 14px;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š é”®ç›˜å‹å¥½å‹å¯ç¼–è¾‘è¡¨æ ¼</h1>
        
        <div class="tip">
            ğŸ’¡ <strong>ä½¿ç”¨æç¤ºï¼š</strong> åœ¨å•å…ƒæ ¼å†…æŒ‰ <kbd>Enter</kbd> è·³è½¬åˆ°ä¸‹ä¸€ä¸ªå•å…ƒæ ¼ï¼Œæœ€åä¸€åˆ—æŒ‰ <kbd>Enter</kbd> è‡ªåŠ¨æ–°å¢è¡Œ | æ•°å­—åˆ—è‡ªåŠ¨åƒåˆ†ä½æ˜¾ç¤º | ä¸‹æ‹‰æ¡†è‡ªåŠ¨å±•å¼€
        </div>

        <div class="controls">
            <button class="btn btn-primary" onclick="addRow()">â• æ·»åŠ è¡Œ</button>
            <button class="btn btn-success" onclick="exportData()">ğŸ“¤ å¯¼å‡ºæ•°æ®</button>
        </div>

        <div class="table-wrapper">
            <table id="dataTable">
                <thead id="tableHead"></thead>
                <tbody id="tableBody"></tbody>
                <tfoot id="tableFoot"></tfoot>
            </table>
        </div>

        <div class="output">
            <h3>ğŸ“‹ å½“å‰æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰</h3>
            <pre id="jsonOutput">[]</pre>
        </div>
    </div>

    <script>
        // è¡¨æ ¼é…ç½®
        const columns = [
            { label: 'å§“å', key: 'name', type: 'text' },
            { label: 'é‡‘é¢1', key: 'amount1', type: 'number', sum: true },
            { label: 'é‡‘é¢2', key: 'amount2', type: 'number', sum: true },
            { label: 'éƒ¨é—¨', key: 'department', type: 'select', options: ['ç ”å‘éƒ¨', 'å¸‚åœºéƒ¨', 'äººäº‹éƒ¨', 'è´¢åŠ¡éƒ¨'] },
            { label: 'èŒä½', key: 'position', type: 'text' },
            { label: 'é‡‘é¢3', key: 'amount3', type: 'number', sum: true },
            { label: 'çŠ¶æ€', key: 'status', type: 'select', options: ['åœ¨èŒ', 'ç¦»èŒ', 'è¯•ç”¨æœŸ'] }
        ];

        // æ•°æ®å­˜å‚¨
        let tableData = [];

        // åˆå§‹åŒ–è¡¨æ ¼
        function initTable() {
            renderTableHead();
            addRow();
            addRow();
        }

        // æ¸²æŸ“è¡¨å¤´
        function renderTableHead() {
            const thead = document.getElementById('tableHead');
            let html = '<tr>';
            columns.forEach(col => {
                html += `<th>${col.label}</th>`;
            });
            html += '<th style="width: 100px;">æ“ä½œ</th></tr>';
            thead.innerHTML = html;
        }

        // æ·»åŠ è¡Œ
        function addRow(data = {}) {
            const rowIndex = tableData.length;
            const rowData = {};
            
            columns.forEach(col => {
                rowData[col.key] = data[col.key] || '';
            });
            
            tableData.push(rowData);
            renderTable();
        }

        // åˆ é™¤è¡Œ
        function deleteRow(index) {
            if (tableData.length <= 1) {
                alert('è‡³å°‘ä¿ç•™ä¸€è¡Œæ•°æ®');
                return;
            }
            tableData.splice(index, 1);
            renderTable();
        }

        // æ¸²æŸ“è¡¨æ ¼
        function renderTable() {
            const tbody = document.getElementById('tableBody');
            
            if (tableData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="' + (columns.length + 1) + '" class="empty-state">æš‚æ— æ•°æ®</td></tr>';
                updateJsonOutput();
                return;
            }

            let html = '';
            tableData.forEach((row, rowIndex) => {
                html += '<tr>';
                columns.forEach((col, colIndex) => {
                    html += '<td>';
                    html += createInputElement(col, rowIndex, colIndex);
                    html += '</td>';
                });
                html += `<td style="text-align: center;">
                    <button class="delete-btn" onclick="deleteRow(${rowIndex})">åˆ é™¤</button>
                </td>`;
                html += '</tr>';
            });
            
            tbody.innerHTML = html;
            renderFooter();
            attachEventListeners();
            updateJsonOutput();
        }

        // åˆ›å»ºè¾“å…¥å…ƒç´ 
        function createInputElement(col, rowIndex, colIndex) {
            const value = tableData[rowIndex][col.key] || '';
            const id = `cell-${rowIndex}-${colIndex}`;
            
            if (col.type === 'select') {
                let options = '<option value="">è¯·é€‰æ‹©</option>';
                col.options.forEach(opt => {
                    options += `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt}</option>`;
                });
                return `<select id="${id}" data-row="${rowIndex}" data-col="${colIndex}">${options}</select>`;
            } else if (col.type === 'number') {
                const displayValue = value ? formatNumber(value) : '';
                return `<input type="text" id="${id}" value="${displayValue}" data-row="${rowIndex}" data-col="${colIndex}" data-raw-value="${value}" placeholder="0.00" class="number-input">`;
            } else {
                return `<input type="text" id="${id}" value="${value}" data-row="${rowIndex}" data-col="${colIndex}" placeholder="è¾“å…¥${col.label}">`;
            }
        }

        // æ ¼å¼åŒ–æ•°å­—ä¸ºåƒåˆ†ä½
        function formatNumber(num) {
            if (!num && num !== 0) return '';
            const number = parseFloat(num);
            if (isNaN(number)) return '';
            return number.toLocaleString('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // è§£æåƒåˆ†ä½æ•°å­—
        function parseFormattedNumber(str) {
            if (!str) return '';
            return str.replace(/,/g, '');
        }

        // æ¸²æŸ“æ±‡æ€»è¡Œ
        function renderFooter() {
            const tfoot = document.getElementById('tableFoot');
            let html = '<tr>';
            
            columns.forEach(col => {
                if (col.sum && col.type === 'number') {
                    const sum = tableData.reduce((total, row) => {
                        const value = parseFloat(row[col.key]) || 0;
                        return total + value;
                    }, 0);
                    html += `<td class="sum-cell">åˆè®¡: ${formatNumber(sum)}</td>`;
                } else {
                    html += '<td></td>';
                }
            });
            
            html += '<td></td></tr>';
            tfoot.innerHTML = html;
        }

        // é™„åŠ äº‹ä»¶ç›‘å¬
        function attachEventListeners() {
            const inputs = document.querySelectorAll('#tableBody input, #tableBody select');
            
            inputs.forEach(input => {
                // ä¸‹æ‹‰é€‰æ‹©æ¡†è·å¾—ç„¦ç‚¹æ—¶è‡ªåŠ¨å±•å¼€
                if (input.tagName === 'SELECT') {
                    input.addEventListener('focus', function() {
                        // è§¦å‘ç‚¹å‡»äº‹ä»¶æ¥å±•å¼€ä¸‹æ‹‰æ¡†
                        setTimeout(() => {
                            if (document.activeElement === this) {
                                this.size = Math.min(this.options.length, 10);
                            }
                        }, 0);
                    });

                    input.addEventListener('blur', function() {
                        this.size = 1;
                    });

                    input.addEventListener('change', function() {
                        const rowIndex = parseInt(this.dataset.row);
                        const colIndex = parseInt(this.dataset.col);
                        tableData[rowIndex][columns[colIndex].key] = this.value;
                        this.size = 1;
                        updateJsonOutput();
                    });
                }

                // æ•°å­—è¾“å…¥æ¡†ç‰¹æ®Šå¤„ç†
                if (input.classList.contains('number-input')) {
                    // è·å¾—ç„¦ç‚¹æ—¶æ˜¾ç¤ºåŸå§‹æ•°å€¼
                    input.addEventListener('focus', function() {
                        const rawValue = this.dataset.rawValue || '';
                        this.value = rawValue;
                        this.select();
                    });

                    // å¤±å»ç„¦ç‚¹æ—¶æ ¼å¼åŒ–ä¸ºåƒåˆ†ä½
                    input.addEventListener('blur', function() {
                        const rawValue = parseFormattedNumber(this.value);
                        this.dataset.rawValue = rawValue;
                        this.value = rawValue ? formatNumber(rawValue) : '';
                        
                        const rowIndex = parseInt(this.dataset.row);
                        const colIndex = parseInt(this.dataset.col);
                        tableData[rowIndex][columns[colIndex].key] = rawValue;
                        renderFooter();
                        updateJsonOutput();
                    });

                    // è¾“å…¥æ—¶åªå…è®¸æ•°å­—å’Œå°æ•°ç‚¹
                    input.addEventListener('input', function(e) {
                        let value = this.value;
                        // ç§»é™¤éæ•°å­—å­—ç¬¦ï¼ˆä¿ç•™æ•°å­—ã€å°æ•°ç‚¹ã€è´Ÿå·ï¼‰
                        value = value.replace(/[^\d.-]/g, '');
                        // ç¡®ä¿åªæœ‰ä¸€ä¸ªå°æ•°ç‚¹
                        const parts = value.split('.');
                        if (parts.length > 2) {
                            value = parts[0] + '.' + parts.slice(1).join('');
                        }
                        // ç¡®ä¿è´Ÿå·åªåœ¨å¼€å¤´
                        if (value.indexOf('-') > 0) {
                            value = value.replace(/-/g, '');
                        }
                        this.value = value;
                    });
                }

                // æ™®é€šæ–‡æœ¬è¾“å…¥æ¡†
                if (input.type === 'text' && !input.classList.contains('number-input')) {
                    input.addEventListener('input', function() {
                        const rowIndex = parseInt(this.dataset.row);
                        const colIndex = parseInt(this.dataset.col);
                        tableData[rowIndex][columns[colIndex].key] = this.value;
                        updateJsonOutput();
                    });
                }

                // å›è½¦é”®äº‹ä»¶
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        // å¦‚æœæ˜¯ä¸‹æ‹‰æ¡†ä¸”å·²å±•å¼€ï¼Œå…ˆæ”¶èµ·
                        if (this.tagName === 'SELECT' && this.size > 1) {
                            this.size = 1;
                        }
                        handleEnterKey(this);
                    }
                });
            });
        }

        // å¤„ç†å›è½¦é”®
        function handleEnterKey(currentElement) {
            const rowIndex = parseInt(currentElement.dataset.row);
            const colIndex = parseInt(currentElement.dataset.col);
            
            // å¦‚æœæ˜¯æœ€åä¸€åˆ—
            if (colIndex === columns.length - 1) {
                // å¦‚æœæ˜¯æœ€åä¸€è¡Œï¼Œæ·»åŠ æ–°è¡Œ
                if (rowIndex === tableData.length - 1) {
                    addRow();
                    // ç­‰å¾…DOMæ›´æ–°åèšç„¦åˆ°æ–°è¡Œç¬¬ä¸€åˆ—
                    setTimeout(() => {
                        const nextInput = document.getElementById(`cell-${rowIndex + 1}-0`);
                        if (nextInput) nextInput.focus();
                    }, 0);
                } else {
                    // è·³è½¬åˆ°ä¸‹ä¸€è¡Œç¬¬ä¸€åˆ—
                    const nextInput = document.getElementById(`cell-${rowIndex + 1}-0`);
                    if (nextInput) nextInput.focus();
                }
            } else {
                // è·³è½¬åˆ°å³è¾¹ä¸‹ä¸€åˆ—
                const nextInput = document.getElementById(`cell-${rowIndex}-${colIndex + 1}`);
                if (nextInput) nextInput.focus();
            }
        }

        // æ›´æ–°JSONè¾“å‡º
        function updateJsonOutput() {
            const output = document.getElementById('jsonOutput');
            output.textContent = JSON.stringify(tableData, null, 2);
        }

        // å¯¼å‡ºæ•°æ®
        function exportData() {
            const dataStr = JSON.stringify(tableData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'table_data_' + new Date().getTime() + '.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', initTable);
    </script>
</body>
</html>